name: Build and Deploy Docs

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'embeddings/**'
      - 'NLP_slides/**'
      - 'binder/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install pdf2image pillow

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Create output directory
        run: mkdir -p _site

      - name: Copy main site files
        run: |
          # Copy HTML files
          cp docs/index.html _site/

          # Copy weeks and modules
          cp -r docs/weeks _site/
          cp -r docs/modules _site/

          # Copy embeddings module (Jekyll content)
          mkdir -p _site/embeddings
          cp docs/embeddings/*.md _site/embeddings/ 2>/dev/null || true
          cp docs/embeddings/*.html _site/embeddings/ 2>/dev/null || true

          # Copy bibliography
          cp docs/bibliography.md _site/ 2>/dev/null || true

      - name: Create placeholder thumbnails
        run: |
          mkdir -p _site/assets/thumbs
          mkdir -p _site/assets/charts

          # Create placeholder SVG thumbnails for weeks
          for i in $(seq -w 1 12); do
            cat > "_site/assets/thumbs/week${i}.png" << 'PLACEHOLDER'
          PLACEHOLDER
          done

          # Actually generate placeholder PNGs with Python
          python3 << 'EOF'
          from PIL import Image, ImageDraw, ImageFont
          import os

          os.makedirs('_site/assets/thumbs', exist_ok=True)
          os.makedirs('_site/assets/charts', exist_ok=True)

          week_titles = {
              '01': 'N-grams',
              '02': 'Embeddings',
              '03': 'RNN/LSTM',
              '04': 'Seq2Seq',
              '05': 'Transformers',
              '06': 'Pre-trained',
              '07': 'Advanced',
              '08': 'Tokenization',
              '09': 'Decoding',
              '10': 'Fine-tuning',
              '11': 'Efficiency',
              '12': 'Ethics'
          }

          for num, title in week_titles.items():
              img = Image.new('RGB', (400, 225), color=(51, 51, 178))
              draw = ImageDraw.Draw(img)
              draw.rectangle([10, 10, 390, 215], outline='white', width=2)
              draw.text((200, 90), f'Week {num}', fill='white', anchor='mm')
              draw.text((200, 130), title, fill='white', anchor='mm')
              img.save(f'_site/assets/thumbs/week{num}.png')

          # Create placeholder chart thumbnails
          chart_names = [
              'skipgram_architecture', 'cbow_architecture', 'transformer_architecture',
              'attention_heatmap', 'beam_search', 'temperature_effects',
              'word_arithmetic', 'embedding_space', 'loss_landscape',
              'rnn_unrolled', 'lstm_gates', 'bert_architecture'
          ]

          for name in chart_names:
              img = Image.new('RGB', (200, 140), color=(248, 250, 252))
              draw = ImageDraw.Draw(img)
              draw.rectangle([5, 5, 195, 135], outline=(226, 232, 240), width=1)
              short_name = name.replace('_', ' ').title()[:15]
              draw.text((100, 70), short_name, fill=(100, 116, 139), anchor='mm')
              img.save(f'_site/assets/charts/{name}.png')

          print("Generated placeholder images")
          EOF

      - name: Convert actual PDFs to thumbnails (if available)
        run: |
          # Try to convert actual week figures to thumbnails
          for i in $(seq -w 1 12); do
            week_dir="NLP_slides/week${i}_*/figures"
            if ls $week_dir/*.pdf 1> /dev/null 2>&1; then
              first_pdf=$(ls $week_dir/*.pdf | head -1)
              if [ -f "$first_pdf" ]; then
                pdftoppm -png -r 100 -singlefile -f 1 -l 1 "$first_pdf" "_site/assets/thumbs/week${i}" 2>/dev/null || true
              fi
            fi
          done

          # Convert embeddings charts
          if [ -d "NLP_slides/week02_neural_lm/figures" ]; then
            for pdf in NLP_slides/week02_neural_lm/figures/*_bsc.pdf; do
              if [ -f "$pdf" ]; then
                name=$(basename "$pdf" .pdf)
                pdftoppm -png -r 100 -singlefile "$pdf" "_site/assets/charts/${name}" 2>/dev/null || true
              fi
            done
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
