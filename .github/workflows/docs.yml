name: Build and Deploy Docs

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - 'embeddings/**'
      - 'NLP_slides/**'
      - 'binder/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pdf2image pillow
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Create directories
        run: |
          mkdir -p _site/assets/images
          mkdir -p _site/weeks
          mkdir -p _site/modules

      - name: Copy site files
        run: |
          cp docs/index.html _site/
          cp -r docs/weeks/* _site/weeks/
          cp -r docs/modules/* _site/modules/
          cp docs/embeddings/*.html _site/ 2>/dev/null || true

      - name: Convert week thumbnails from PDFs
        run: |
          # Week 01 - N-gram Foundations
          if [ -f "NLP_slides/week01_foundations/figures/bigram_calculation_steps_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week01_foundations/figures/bigram_calculation_steps_bsc.pdf" "_site/assets/images/week01"
          fi

          # Week 02 - Word Embeddings
          if [ -f "NLP_slides/week02_neural_lm/figures/skipgram_architecture_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week02_neural_lm/figures/skipgram_architecture_bsc.pdf" "_site/assets/images/week02"
          fi

          # Week 03 - RNN/LSTM
          if [ -f "NLP_slides/week03_rnn/figures/lstm_cell_anatomy.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week03_rnn/figures/lstm_cell_anatomy.pdf" "_site/assets/images/week03"
          elif [ -f "NLP_slides/week03_rnn/figures/forget_gate_detail_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week03_rnn/figures/forget_gate_detail_bsc.pdf" "_site/assets/images/week03"
          fi

          # Week 04 - Seq2Seq
          if [ -f "NLP_slides/week04_seq2seq/figures/ink_accent_architecture.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week04_seq2seq/figures/ink_accent_architecture.pdf" "_site/assets/images/week04"
          fi

          # Week 05 - Transformers
          if [ -f "NLP_slides/week05_transformers/figures/3d_transformer_architecture.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week05_transformers/figures/3d_transformer_architecture.pdf" "_site/assets/images/week05"
          fi

          # Week 06 - Pre-trained
          if [ -f "NLP_slides/week06_pretrained/figures/bert_architecture_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week06_pretrained/figures/bert_architecture_bsc.pdf" "_site/assets/images/week06"
          elif [ -f "NLP_slides/week06_pretrained/figures/2018_breakthrough_timeline_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week06_pretrained/figures/2018_breakthrough_timeline_bsc.pdf" "_site/assets/images/week06"
          fi

          # Week 07 - Advanced
          if [ -f "NLP_slides/week07_advanced/figures/scaling_laws_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week07_advanced/figures/scaling_laws_bsc.pdf" "_site/assets/images/week07"
          elif [ -f "NLP_slides/week07_advanced/figures/3d_parallelism.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week07_advanced/figures/3d_parallelism.pdf" "_site/assets/images/week07"
          fi

          # Week 08 - Tokenization
          if [ -f "NLP_slides/week08_tokenization/figures/bpe_merge_detail_visual.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week08_tokenization/figures/bpe_merge_detail_visual.pdf" "_site/assets/images/week08"
          fi

          # Week 09 - Decoding
          if [ -f "NLP_slides/week09_decoding/figures/beam_search_tree_graphviz.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week09_decoding/figures/beam_search_tree_graphviz.pdf" "_site/assets/images/week09"
          fi

          # Week 10 - Fine-tuning
          if [ -f "NLP_slides/week10_finetuning/figures/lora_architecture_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week10_finetuning/figures/lora_architecture_bsc.pdf" "_site/assets/images/week10"
          elif [ -f "NLP_slides/week10_finetuning/figures/adaptation_decision_tree.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week10_finetuning/figures/adaptation_decision_tree.pdf" "_site/assets/images/week10"
          fi

          # Week 11 - Efficiency
          if [ -f "NLP_slides/week11_efficiency/figures/quantization_visual_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week11_efficiency/figures/quantization_visual_bsc.pdf" "_site/assets/images/week11"
          elif [ -f "NLP_slides/week11_efficiency/figures/accuracy_size_pareto.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week11_efficiency/figures/accuracy_size_pareto.pdf" "_site/assets/images/week11"
          fi

          # Week 12 - Ethics
          if [ -f "NLP_slides/week12_ethics/figures/bias_detection_bsc.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week12_ethics/figures/bias_detection_bsc.pdf" "_site/assets/images/week12"
          elif [ -f "NLP_slides/week12_ethics/figures/ai_ethics_landscape.pdf" ]; then
            pdftoppm -png -r 150 -singlefile "NLP_slides/week12_ethics/figures/ai_ethics_landscape.pdf" "_site/assets/images/week12"
          fi

      - name: Convert gallery charts
        run: |
          # Embeddings charts
          for pdf in NLP_slides/week02_neural_lm/figures/*_bsc.pdf; do
            if [ -f "$pdf" ]; then
              name=$(basename "$pdf" .pdf)
              pdftoppm -png -r 100 -singlefile "$pdf" "_site/assets/images/${name}" 2>/dev/null || true
            fi
          done

          # Transformer charts
          for pdf in NLP_slides/week05_transformers/figures/3d_*.pdf; do
            if [ -f "$pdf" ]; then
              name=$(basename "$pdf" .pdf)
              pdftoppm -png -r 100 -singlefile "$pdf" "_site/assets/images/${name}" 2>/dev/null || true
            fi
          done

          # Decoding charts
          for pdf in NLP_slides/week09_decoding/figures/*_bsc.pdf; do
            if [ -f "$pdf" ]; then
              name=$(basename "$pdf" .pdf)
              pdftoppm -png -r 100 -singlefile "$pdf" "_site/assets/images/${name}" 2>/dev/null || true
            fi
          done

      - name: Create placeholder images for missing thumbnails
        run: |
          python3 << 'EOF'
          from PIL import Image, ImageDraw
          import os

          week_data = {
              '01': ('N-grams', '#1e3a5f'),
              '02': ('Embeddings', '#2563eb'),
              '03': ('RNN/LSTM', '#3333B2'),
              '04': ('Seq2Seq', '#1e3a5f'),
              '05': ('Transformers', '#2563eb'),
              '06': ('Pre-trained', '#3333B2'),
              '07': ('Advanced', '#1e3a5f'),
              '08': ('Tokenization', '#2563eb'),
              '09': ('Decoding', '#3333B2'),
              '10': ('Fine-tuning', '#1e3a5f'),
              '11': ('Efficiency', '#2563eb'),
              '12': ('Ethics', '#3333B2'),
          }

          os.makedirs('_site/assets/images', exist_ok=True)

          for num, (title, color) in week_data.items():
              path = f'_site/assets/images/week{num}.png'
              if not os.path.exists(path):
                  # Create placeholder
                  r, g, b = int(color[1:3], 16), int(color[3:5], 16), int(color[5:7], 16)
                  img = Image.new('RGB', (400, 250), color=(r, g, b))
                  draw = ImageDraw.Draw(img)
                  draw.rectangle([8, 8, 392, 242], outline='white', width=2)
                  draw.text((200, 100), f'Week {num}', fill='white', anchor='mm')
                  draw.text((200, 150), title, fill='white', anchor='mm')
                  img.save(path)
                  print(f'Created placeholder: {path}')
              else:
                  print(f'Using converted: {path}')
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
